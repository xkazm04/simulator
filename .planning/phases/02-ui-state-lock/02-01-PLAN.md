---
phase: 02-ui-state-lock
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/features/simulator/subfeature_brain/components/DirectorControl.tsx
  - app/features/simulator/subfeature_brain/components/ActivityProgressCenter.tsx
  - app/features/simulator/subfeature_brain/components/AutoplaySetupModal.tsx
autonomous: true

must_haves:
  truths:
    - "Generate button label shows GENERATING/EVALUATING/POLISHING/REFINING based on current autoplay status"
    - "Activity Modal progress center displays current iteration number"
    - "Status badge in Activity Modal header reflects current operation"
  artifacts:
    - path: "app/features/simulator/subfeature_brain/components/DirectorControl.tsx"
      provides: "getStatusLabel function for accurate button labels"
      contains: "getStatusLabel"
    - path: "app/features/simulator/subfeature_brain/components/ActivityProgressCenter.tsx"
      provides: "Iteration counter display"
      contains: "Iteration"
  key_links:
    - from: "DirectorControl.tsx"
      to: "multiPhaseAutoplay.phase"
      via: "getStatusLabel function"
      pattern: "getStatusLabel.*multiPhaseAutoplay"
---

<objective>
Wire autoplay state machine status to UI elements so users see accurate progress during autoplay.

Purpose: Users currently see generic "SIMULATING..." regardless of what's actually happening. This plan makes the UI reflect the actual operation (generating/evaluating/polishing/refining) and shows iteration count.

Output: Generate button shows accurate status labels; Activity Modal shows iteration counter.
</objective>

<execution_context>
@C:\Users\mkdol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\mkdol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ui-state-lock/02-RESEARCH.md

# Key source files
@app/features/simulator/subfeature_brain/components/DirectorControl.tsx
@app/features/simulator/subfeature_brain/components/ActivityProgressCenter.tsx
@app/features/simulator/hooks/useAutoplay.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add status label derivation to DirectorControl</name>
  <files>app/features/simulator/subfeature_brain/components/DirectorControl.tsx</files>
  <action>
Add a `getStatusLabel` function that derives human-readable labels from autoplay state. The function should:

1. Check `multiPhaseAutoplay?.isRunning` first
2. If running, derive label from `multiPhaseAutoplay.phase`:
   - 'sketch' or 'gameplay' phases: Show "GENERATING..." (or could be enhanced later with single-phase status)
   - 'poster' phase: Show "SELECTING POSTER..."
   - 'hud' phase: Show "GENERATING HUD..."
   - Default: Show "SIMULATING..."
3. If `isRefining` is true: Show "REFINING..."
4. If `isGeneratingPoster` is true: Show "GENERATING POSTER..."
5. If `simulator.isGenerating` is true: Show "SIMULATING..."
6. Otherwise: Show "GENERATE"

Location: Add the function inside the DirectorControl component, before the return statement.

Then update the button label section (around line 599-601) to use this function instead of the hardcoded conditional strings.

Current code to replace:
```tsx
{isRefining ? 'REFINING...' : isGeneratingPoster ? 'GENERATING POSTER...' : 'SIMULATING...'}
```

Replace with:
```tsx
{getStatusLabel()}
```

Also update the gradient classes to match the label (use amber for refining, rose for poster, cyan for others).
  </action>
  <verify>
Run `npm run build` - TypeScript should compile without errors.
Visually verify: The generate button should display different labels based on autoplay phase.
  </verify>
  <done>
Generate button label derives from autoplay state. Labels: GENERATE (idle), SIMULATING, GENERATING, EVALUATING, REFINING, SELECTING POSTER, GENERATING HUD based on current operation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add iteration counter to ActivityProgressCenter</name>
  <files>app/features/simulator/subfeature_brain/components/ActivityProgressCenter.tsx</files>
  <action>
First, examine the ActivityProgressCenter component to understand its current props and structure.

Then add iteration display:

1. Add new props to the component interface:
   - `currentIteration?: number` - Current iteration number (1-based)
   - `maxIterations?: number` - Total iterations configured

2. In the component body, add an iteration indicator section. Position it prominently (likely near the top or alongside the phase indicator).

Display format: "Iteration {current} of {max}" or "Iteration {current}" if max is not provided.

Style: Use font-mono, text-sm, with cyan accent color to match the app's design system.

3. The props will be passed from AutoplaySetupModal's ActivityModeContent. Check if useAutoplay exposes `currentIteration` and `maxIterations` in its return value - if so, these should be threaded through from the orchestrator.

Note: The orchestrator (useMultiPhaseAutoplay) may need to expose these values. The UI should gracefully handle missing values by showing nothing when iteration data is not provided. For this plan, focus on adding the UI capability - data wiring from useAutoplay.state.currentIteration through useMultiPhaseAutoplay can be done as enhancement in Phase 3 if needed.
  </action>
  <verify>
Run `npm run build` - TypeScript should compile without errors.
Check that ActivityProgressCenter accepts optional iteration props.
  </verify>
  <done>
ActivityProgressCenter has iteration display. Shows "Iteration X of Y" when props provided, gracefully hides when not.
  </done>
</task>

<task type="auto">
  <name>Task 3: Thread iteration props through Activity Modal</name>
  <files>
app/features/simulator/subfeature_brain/components/AutoplaySetupModal.tsx
app/features/simulator/subfeature_brain/components/DirectorControl.tsx
  </files>
  <action>
Wire the iteration counter from the orchestrator through to ActivityProgressCenter:

1. In AutoplaySetupModal.tsx:
   - Add `currentIteration?: number` and `maxIterations?: number` to AutoplaySetupModalProps
   - Pass these props to ActivityModeContent
   - ActivityModeContent should pass them to ActivityProgressCenter

2. In DirectorControl.tsx:
   - The multiPhaseAutoplay prop comes from OnionLayout. Check if it currently includes iteration info.
   - If not, the iteration info needs to come from the single-phase autoplay state.
   - For now, since we're in multi-phase mode, we can derive a simple "iteration" from the progress:
     - During 'sketch' phase: Use sketchProgress.saved as proxy for completed iterations
     - During 'gameplay' phase: Use gameplayProgress.saved
   - This is a simplification - true iteration count comes from useAutoplay.state.currentIteration

3. Update the DirectorControl's modal calls to pass iteration props:
   - When calling autoplayModal.open with AutoplaySetupModal, add:
     - currentIteration={...derive from progress or state...}
     - maxIterations={...from config...}

Note: Perfect iteration tracking requires exposing useAutoplay state through useMultiPhaseAutoplay. For this plan, use progress.saved as a reasonable proxy. A future enhancement could add explicit iteration tracking to multi-phase.
  </action>
  <verify>
Run `npm run build` - TypeScript should compile without errors.
The Activity Modal should show iteration information when autoplay is running.
  </verify>
  <done>
Iteration props flow from DirectorControl through AutoplaySetupModal to ActivityProgressCenter. Iteration display visible in Activity Modal during autoplay.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npm run build` passes without TypeScript errors
2. Start the dev server with `npm run dev`
3. Open the app and trigger autoplay
4. Verify: Generate button shows status that changes during autoplay (GENERATING -> EVALUATING -> REFINING)
5. Verify: Activity Modal shows iteration counter
6. Verify: Phase badge in Activity Modal header reflects current phase
</verification>

<success_criteria>
- STATE-01: Generate button label reflects current operation (idle/generating/evaluating/refining)
- STATE-02: Activity Modal displays iteration progress
- STATE-03: Iteration counter visible and updates during autoplay cycles
</success_criteria>

<output>
After completion, create `.planning/phases/02-ui-state-lock/02-01-SUMMARY.md`
</output>
