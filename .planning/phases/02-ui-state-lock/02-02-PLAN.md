---
phase: 02-ui-state-lock
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/features/simulator/subfeature_dimensions/components/DimensionCard.tsx
  - app/features/simulator/subfeature_dimensions/components/DimensionGrid.tsx
  - app/features/simulator/subfeature_dimensions/components/DimensionColumn.tsx
  - app/features/simulator/subfeature_brain/components/CentralBrain.tsx
autonomous: true

must_haves:
  truths:
    - "Dimension textarea inputs are read-only (non-editable) during autoplay"
    - "SmartBreakdown is disabled during autoplay"
    - "Manual generate button is disabled during autoplay (LOCK-02 verified)"
    - "Abort button remains clickable during autoplay (LOCK-04 verified)"
  artifacts:
    - path: "app/features/simulator/subfeature_dimensions/components/DimensionCard.tsx"
      provides: "disabled prop for textarea"
      contains: "disabled"
    - path: "app/features/simulator/subfeature_dimensions/components/DimensionGrid.tsx"
      provides: "disabled prop passthrough"
      contains: "disabled"
    - path: "app/features/simulator/subfeature_brain/components/CentralBrain.tsx"
      provides: "isAutoplayLocked check for SmartBreakdown"
      contains: "isAutoplayLocked"
  key_links:
    - from: "DimensionColumn.tsx"
      to: "DimensionGrid.tsx"
      via: "disabled prop"
      pattern: "disabled="
    - from: "DimensionGrid.tsx"
      to: "DimensionCard.tsx"
      via: "disabled prop"
      pattern: "disabled.*disabled"
    - from: "CentralBrain.tsx"
      to: "SmartBreakdown.tsx"
      via: "isDisabled prop with autoplay check"
      pattern: "isDisabled.*isAutoplayLocked"
---

<objective>
Lock dimension inputs and SmartBreakdown during autoplay to prevent user interference with the automated generation loop.

Purpose: When autoplay is running, users should not be able to modify dimensions or trigger Smart Breakdown as this could cause conflicts with the automated workflow. The abort button must remain clickable (LOCK-04).

Output: All dimension textareas are disabled during autoplay; SmartBreakdown is disabled during autoplay; abort button remains functional.
</objective>

<execution_context>
@C:\Users\mkdol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\mkdol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ui-state-lock/02-RESEARCH.md

# Key source files
@app/features/simulator/subfeature_dimensions/components/DimensionCard.tsx
@app/features/simulator/subfeature_dimensions/components/DimensionGrid.tsx
@app/features/simulator/subfeature_dimensions/components/DimensionColumn.tsx
@app/features/simulator/subfeature_brain/components/CentralBrain.tsx
@app/features/simulator/SimulatorContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add disabled prop to DimensionCard</name>
  <files>app/features/simulator/subfeature_dimensions/components/DimensionCard.tsx</files>
  <action>
Add a `disabled` prop to DimensionCard that disables the textarea input:

1. Add to DimensionCardProps interface (around line 50):
```typescript
/** Whether the card inputs are disabled (e.g., during autoplay) */
disabled?: boolean;
```

2. Destructure the prop in DimensionCardComponent (around line 64):
```typescript
function DimensionCardComponent({
  dimension,
  onChange,
  onWeightChange,
  onFilterModeChange,
  onTransformModeChange,
  onRemove,
  index,
  onDropElement,
  onReferenceImageChange,
  disabled,  // ADD THIS
}: DimensionCardProps) {
```

3. Apply to the textarea (around line 421-428):
```tsx
<textarea
  value={dimension.reference}
  onChange={(e) => onChange(dimension.id, e.target.value)}
  placeholder={dimension.placeholder || `Describe ${dimension.label.toLowerCase()}...`}
  rows={8}
  disabled={disabled}  // ADD THIS
  className={`w-full bg-transparent text-xs text-slate-300 placeholder-slate-600
            resize-none outline-none font-mono leading-relaxed flex-1 h-full min-h-[140px]
            ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}  // ADD DISABLED STYLES
/>
```

4. Also disable the lens control buttons and image upload when disabled is true. Add disabled checks to:
   - Filter mode buttons (line ~329-343)
   - Transform mode buttons (line ~352-366)
   - Weight slider (line ~303-316)
   - Image upload button (line ~249-259)

5. Update the arePropsEqual function (line ~457-480) to include disabled:
```typescript
if (prevProps.disabled !== nextProps.disabled) return false;
```
  </action>
  <verify>
Run `npm run build` - TypeScript should compile without errors.
Verify DimensionCard accepts disabled prop and applies it to interactive elements.
  </verify>
  <done>
DimensionCard has disabled prop. When true: textarea is read-only with visual indicator, lens controls disabled, image upload disabled.
  </done>
</task>

<task type="auto">
  <name>Task 2: Propagate disabled through DimensionGrid and DimensionColumn</name>
  <files>
app/features/simulator/subfeature_dimensions/components/DimensionGrid.tsx
app/features/simulator/subfeature_dimensions/components/DimensionColumn.tsx
  </files>
  <action>
Thread the disabled prop from DimensionColumn through DimensionGrid to DimensionCard:

**In DimensionGrid.tsx:**

1. Add to DimensionGridProps interface:
```typescript
/** Whether all dimension cards are disabled (e.g., during autoplay) */
disabled?: boolean;
```

2. Destructure in component:
```typescript
export function DimensionGrid({
  dimensions,
  onChange,
  // ... other props
  disabled,  // ADD THIS
}: DimensionGridProps) {
```

3. Pass to each DimensionCard in the map (find where DimensionCard is rendered):
```tsx
<DimensionCard
  key={dimension.id}
  dimension={dimension}
  // ... other props
  disabled={disabled}  // ADD THIS
/>
```

**In DimensionColumn.tsx:**

1. Add to DimensionColumnProps interface:
```typescript
/** Whether dimension inputs are disabled (e.g., during autoplay) */
disabled?: boolean;
```

2. Destructure in component (line ~38-46):
```typescript
export function DimensionColumn({
  side,
  label,
  collapsedLabel,
  dimensions,
  onReorder,
  isExpanded: controlledExpanded,
  onToggleExpand: controlledToggle,
  disabled,  // ADD THIS
}: DimensionColumnProps) {
```

3. Pass to DimensionGrid (around line 173-184):
```tsx
<DimensionGrid
  dimensions={dimensions}
  onChange={dimensionsCtx.handleDimensionChange}
  // ... other props
  disabled={disabled}  // ADD THIS
/>
```
  </action>
  <verify>
Run `npm run build` - TypeScript should compile without errors.
Verify prop chain: DimensionColumn -> DimensionGrid -> DimensionCard.
  </verify>
  <done>
disabled prop flows from DimensionColumn through DimensionGrid to each DimensionCard. All three components accept and pass the prop.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire autoplay lock state to SmartBreakdown and DimensionColumn</name>
  <files>
app/features/simulator/subfeature_brain/components/CentralBrain.tsx
app/features/simulator/components/variants/OnionLayout.tsx
  </files>
  <action>
Wire the autoplay running state to disable SmartBreakdown and dimension inputs:

**In CentralBrain.tsx:**

1. Derive `isAutoplayLocked` from `multiPhaseAutoplay` prop (add near line 108):
```typescript
const isAutoplayLocked = multiPhaseAutoplay?.isRunning ?? false;
```

2. Update SmartBreakdown's isDisabled prop (around line 204-208):
```tsx
<SmartBreakdown
  onApply={handleSmartBreakdownApply}
  initialVisionSentence={brain.visionSentence}
  isDisabled={simulator.isGenerating || isAutoplayLocked}  // ADD isAutoplayLocked
/>
```

**In OnionLayout.tsx (or wherever DimensionColumn is rendered):**

Find where DimensionColumn components are rendered. This is likely in a layout component that passes dimensions to columns.

1. First, locate where DimensionColumn is used - grep for "DimensionColumn" usage
2. Add the multiPhaseAutoplay prop access (it should already be available in OnionLayout)
3. Derive isAutoplayLocked:
```typescript
const isAutoplayLocked = multiPhaseAutoplay?.isRunning ?? false;
```

4. Pass disabled to DimensionColumn:
```tsx
<DimensionColumn
  side="left"
  // ... other props
  disabled={isAutoplayLocked}
/>
```

Do this for both left and right DimensionColumn instances if there are two.

**IMPORTANT for LOCK-02:** Verify the generate button in DirectorControl.tsx is disabled during autoplay:

1. Find the generate button's disabled logic (search for the main generate button)
2. Verify it includes either `multiPhaseAutoplay?.isRunning` or an equivalent check like `isAutoplayLocked`
3. If the check is missing, add `|| multiPhaseAutoplay?.isRunning` to the disabled condition:
```tsx
<button
  disabled={isAnyGenerating || multiPhaseAutoplay?.isRunning || /* other conditions */}
  ...
>
```

**IMPORTANT for LOCK-04:** Verify the abort button in AutoplaySetupModal does NOT have a disabled prop. The abort button (around line 628-637 in AutoplaySetupModal.tsx) should remain clickable at all times. If you see any disabled logic on the abort button, remove it. The current code is correct:
```tsx
<button
  onClick={onStop}
  // NO disabled prop - abort is ALWAYS clickable
  className={...}
>
```
  </action>
  <verify>
Run `npm run build` - TypeScript should compile without errors.
Manual test:
1. Start autoplay
2. Verify dimension textareas are grayed out and non-editable
3. Verify SmartBreakdown input and Parse button are disabled
4. Verify Stop Autoplay button remains clickable (LOCK-04)
5. Verify Generate button is disabled during autoplay (LOCK-02)
  </verify>
  <done>
SmartBreakdown disabled during autoplay. Dimension inputs disabled during autoplay. Abort button remains clickable (LOCK-04 verified).
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npm run build` passes without TypeScript errors
2. Start the dev server with `npm run dev`
3. Start autoplay and verify:
   - Dimension textareas show disabled state (opacity-50, cursor-not-allowed)
   - Cannot type in dimension textareas
   - SmartBreakdown input and Parse button are disabled
   - Stop Autoplay button is always clickable
4. Stop autoplay and verify:
   - Dimension textareas are editable again
   - SmartBreakdown is functional again
</verification>

<success_criteria>
- LOCK-01: Dimension inputs become read-only during autoplay
- LOCK-02: Manual generate button disabled during autoplay (verified and wired if needed)
- LOCK-03: Smart Breakdown disabled during autoplay
- LOCK-04: User can abort autoplay at any time (abort button remains clickable)
</success_criteria>

<output>
After completion, create `.planning/phases/02-ui-state-lock/02-02-SUMMARY.md`
</output>
