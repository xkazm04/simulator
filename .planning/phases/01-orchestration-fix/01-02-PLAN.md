---
phase: 01-orchestration-fix
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - app/features/simulator/hooks/useMultiPhaseAutoplay.ts
  - app/features/simulator/hooks/useAutoplayOrchestrator.ts
autonomous: true

must_haves:
  truths:
    - "Multi-phase autoplay progresses through sketch and gameplay phases automatically"
    - "Each phase triggers image generation without stalling"
    - "No timeout errors appear during normal autoplay operation"
  artifacts:
    - path: "app/features/simulator/hooks/useMultiPhaseAutoplay.ts"
      provides: "Multi-phase delegation to single-phase orchestrator"
      contains: "useAutoplayOrchestrator"
    - path: "app/features/simulator/hooks/useAutoplayOrchestrator.ts"
      provides: "Reasonable timeout values"
      contains: "TIMEOUT_MS"
  key_links:
    - from: "useMultiPhaseAutoplay.ts"
      to: "useAutoplayOrchestrator"
      via: "Hook invocation with orchestratorDeps"
      pattern: "useAutoplayOrchestrator\\(orchestratorDeps\\)"
    - from: "useMultiPhaseAutoplay.ts:phase effect"
      to: "singlePhaseOrchestrator.startAutoplay"
      via: "Phase transition delegation"
      pattern: "startAutoplay.*targetSaved"
---

<objective>
Fix multi-phase autoplay to properly delegate to single-phase orchestrator and remove overly aggressive timeouts

Purpose: The multi-phase hook creates orchestrator dependencies but never actually uses them with `useAutoplayOrchestrator`. This leaves image generation orphaned. Additionally, the current 60-second timeout is too aggressive for some AI image generation services.

Output: Working multi-phase autoplay that progresses through all configured phases without manual intervention or timeout errors
</objective>

<execution_context>
@C:\Users\mkdol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\mkdol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-orchestration-fix/01-RESEARCH.md
@.planning/phases/01-orchestration-fix/01-01-SUMMARY.md

# Key source files
@app/features/simulator/hooks/useMultiPhaseAutoplay.ts
@app/features/simulator/hooks/useAutoplayOrchestrator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire multi-phase to use single-phase orchestrator</name>
  <files>app/features/simulator/hooks/useMultiPhaseAutoplay.ts</files>
  <action>
**Step 0: Verify import exists**
Search for `import { useAutoplayOrchestrator` at the top of the file. This import should already exist (currently at line 32). If not present, add:
```typescript
import { useAutoplayOrchestrator, AutoplayOrchestratorDeps } from './useAutoplayOrchestrator';
```

**Step 1: Instantiate the orchestrator**
Locate where `orchestratorDeps` is created by searching for `const orchestratorDeps: AutoplayOrchestratorDeps = useMemo`. This creates the deps object (around lines 291-332) but never calls the hook.

IMMEDIATELY AFTER the closing of the `orchestratorDeps` useMemo (after the closing `]);`), add:
```typescript
// ACTUALLY USE the orchestrator for image generation
const singlePhaseOrchestrator = useAutoplayOrchestrator(orchestratorDeps);
```

**Step 2: Add delegation effect**
Locate the end of the "Effect: Handle phase transitions" by searching for `}, [state, setOutputMode, logEvent]);` - this is the dependency array closing the phase transition effect.

AFTER this effect (after the `});` that closes it), add a new effect for delegation:
```typescript
/**
 * Effect: Delegate image generation phases to single-phase orchestrator
 * When multi-phase enters 'sketch' or 'gameplay', start the single-phase orchestrator
 * which handles the actual generate -> evaluate -> refine loop
 */
useEffect(() => {
  const { phase, config, sketchProgress, gameplayProgress } = state;

  // Only delegate for image generation phases
  if (phase !== 'sketch' && phase !== 'gameplay') {
    return;
  }

  // Calculate target for current phase
  const targetForPhase = phase === 'sketch'
    ? config.sketchCount - sketchProgress.saved
    : config.gameplayCount - gameplayProgress.saved;

  // If we've already met the target, don't start orchestrator
  if (targetForPhase <= 0) {
    return;
  }

  // Only start if not already running
  if (!singlePhaseOrchestrator.isRunning && singlePhaseOrchestrator.canStart) {
    console.log(`[MultiPhase] Delegating ${phase} phase to single-phase orchestrator (target: ${targetForPhase})`);
    singlePhaseOrchestrator.startAutoplay({
      targetSavedCount: targetForPhase,
      maxIterations: config.maxIterationsPerImage,
    });
  }
}, [state.phase, state.config, state.sketchProgress, state.gameplayProgress, singlePhaseOrchestrator]);
```

**Step 3: Add completion detection effect**
IMMEDIATELY AFTER the delegation effect added in Step 2, add:
```typescript
/**
 * Effect: Detect single-phase completion and advance multi-phase
 */
useEffect(() => {
  const { phase } = state;

  if (phase !== 'sketch' && phase !== 'gameplay') {
    return;
  }

  // When single-phase orchestrator completes, advance to next phase
  if (!singlePhaseOrchestrator.isRunning && singlePhaseOrchestrator.completionReason) {
    console.log(`[MultiPhase] Single-phase completed: ${singlePhaseOrchestrator.completionReason}`);

    // Check if we should advance based on saved count
    const progress = phase === 'sketch' ? state.sketchProgress : state.gameplayProgress;
    const target = phase === 'sketch' ? state.config.sketchCount : state.config.gameplayCount;

    if (progress.saved >= target || singlePhaseOrchestrator.completionReason !== 'target_met') {
      dispatch({ type: 'ADVANCE_PHASE' });
    }

    // Reset single-phase for potential reuse
    singlePhaseOrchestrator.resetAutoplay();
  }
}, [state, singlePhaseOrchestrator.isRunning, singlePhaseOrchestrator.completionReason, singlePhaseOrchestrator.resetAutoplay]);
```

WHY: Multi-phase was creating the deps but never using them. Now it properly delegates image generation to the single-phase orchestrator, which handles the complete generate -> evaluate -> refine loop. Multi-phase only needs to track overall progress and advance phases.
  </action>
  <verify>
- TypeScript compiles: `npm run build` passes
- Run: `grep -n "useAutoplayOrchestrator(orchestratorDeps)" app/features/simulator/hooks/useMultiPhaseAutoplay.ts` - should show the hook call
- Console logs show delegation: "[MultiPhase] Delegating sketch phase to single-phase orchestrator"
  </verify>
  <done>
- `useAutoplayOrchestrator(orchestratorDeps)` is called and assigned to `singlePhaseOrchestrator`
- Delegation effect starts single-phase when multi-phase enters sketch/gameplay
- Completion effect advances multi-phase when single-phase finishes
  </done>
</task>

<task type="auto">
  <name>Task 2: Increase timeout in single-phase orchestrator</name>
  <files>app/features/simulator/hooks/useAutoplayOrchestrator.ts</files>
  <action>
1. Locate the timeout safety net effect by searching for `const TIMEOUT_MS = 60000`. This is inside the "Effect: Timeout safety net" block.

2. Change the timeout value from 60 seconds to 120 seconds:
   ```typescript
   const TIMEOUT_MS = 120000; // 120 seconds - generous for slow AI services
   ```

3. Update the log message and error message in the same block to reflect the new timeout. Find the `setTimeout` callback and update:
   ```typescript
   console.error('[Autoplay] Timeout: stuck in generating state for', TIMEOUT_MS / 1000, 'seconds');
   logEvent('timeout', 'Generation timed out after 120 seconds');
   autoplay.setError('Generation timed out - please try again');
   ```

WHY: The 60-second timeout was too aggressive for some AI image generation services that may take 30-60 seconds per image. 120 seconds provides more headroom while still catching true stalls. The callback-based fix from Plan 01 should make timeouts rare.
  </action>
  <verify>
- Run: `grep -n "TIMEOUT_MS.*120000" app/features/simulator/hooks/useAutoplayOrchestrator.ts` - should show the updated timeout
- TypeScript compiles: `npm run build` passes
  </verify>
  <done>
- Single-phase timeout increased to 120 seconds
- Log messages reflect new timeout value
  </done>
</task>

<task type="auto">
  <name>Task 3: Add explanatory comment to multi-phase timeout</name>
  <files>app/features/simulator/hooks/useMultiPhaseAutoplay.ts</files>
  <action>
1. Locate the phase timeout effect by searching for `const PHASE_TIMEOUT_MS = 120000`. This is inside the "Effect: Phase timeout safety" block.

2. The timeout value (120 seconds) is already reasonable. Add an explanatory comment above the constant:
   ```typescript
   // Phase timeout: 2 minutes allows for multiple image generations + evaluations
   // This is a safety net, not the normal exit path
   const PHASE_TIMEOUT_MS = 120000; // 2 minutes per phase
   ```

WHY: This documents the reasoning for the timeout value for future maintainers.
  </action>
  <verify>
- Run: `grep -A1 "Phase timeout:" app/features/simulator/hooks/useMultiPhaseAutoplay.ts` - should show the comment and constant
  </verify>
  <done>
- Multi-phase timeout has explanatory comment
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build check:** `npm run build` succeeds without TypeScript errors
2. **Multi-phase autoplay test:**
   - Open app at localhost:3000
   - Add a base image
   - Open Activity Mode modal
   - Configure: 1 sketch image, 1 gameplay image
   - Start autoplay
   - VERIFY: Sketch phase completes and gameplay phase begins automatically
   - VERIFY: Both phases complete without user intervention
   - VERIFY: No timeout errors appear
3. **Phase progression:**
   - Console shows "[MultiPhase] Delegating sketch phase to single-phase orchestrator"
   - Console shows "[MultiPhase] Single-phase completed: target_met"
   - Console shows "[MultiPhase] Delegating gameplay phase to single-phase orchestrator"
   - Phase completes without timing out
</verification>

<success_criteria>
- [ ] Import for `useAutoplayOrchestrator` verified/present
- [ ] `useAutoplayOrchestrator` is instantiated in multi-phase hook
- [ ] Delegation effect starts single-phase for sketch/gameplay phases
- [ ] Completion effect advances multi-phase when single-phase finishes
- [ ] Single-phase timeout increased to 120 seconds in orchestrator
- [ ] Multi-phase timeout has explanatory comment
- [ ] `npm run build` passes
- [ ] Multi-phase progresses through all phases automatically
- [ ] No timeout errors during normal operation
</success_criteria>

<output>
After completion, create `.planning/phases/01-orchestration-fix/01-02-SUMMARY.md`
</output>
