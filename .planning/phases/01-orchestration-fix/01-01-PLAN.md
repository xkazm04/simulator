---
phase: 01-orchestration-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/features/simulator/SimulatorContext.tsx
  - app/features/simulator/hooks/useAutoplayOrchestrator.ts
autonomous: true

must_haves:
  truths:
    - "Starting autoplay triggers image generation within 5 seconds"
    - "Generated prompts immediately flow to image generation"
    - "Manual Generate button still works correctly"
  artifacts:
    - path: "app/features/simulator/SimulatorContext.tsx"
      provides: "GenerateOverrides with onPromptsReady callback"
      contains: "onPromptsReady"
    - path: "app/features/simulator/hooks/useAutoplayOrchestrator.ts"
      provides: "Callback-based prompt propagation"
      contains: "onPromptsReady"
  key_links:
    - from: "SimulatorContext.tsx:handleGenerate"
      to: "onPromptsReady callback"
      via: "Direct invocation after setGeneratedPrompts"
      pattern: "overrides\\.onPromptsReady"
    - from: "useAutoplayOrchestrator.ts:generating case"
      to: "generateImagesFromPrompts"
      via: "onPromptsReady callback"
      pattern: "onPromptsReady.*generateImagesFromPrompts"
---

<objective>
Fix single-phase autoplay orchestration so image generation triggers immediately when prompts are ready

Purpose: The current orchestrator watches `generatedPrompts` state for changes, but React's batched state updates cause the effect to fire before new prompts propagate. This fix uses a callback pattern to bypass async state timing issues.

Output: Working single-phase autoplay that triggers image generation within 5 seconds of starting
</objective>

<execution_context>
@C:\Users\mkdol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\mkdol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-orchestration-fix/01-RESEARCH.md

# Key source files
@app/features/simulator/SimulatorContext.tsx
@app/features/simulator/hooks/useAutoplayOrchestrator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add onPromptsReady callback to GenerateOverrides</name>
  <files>app/features/simulator/SimulatorContext.tsx</files>
  <action>
1. Update the `GenerateOverrides` interface (around line 30) to add:
   ```typescript
   onPromptsReady?: (prompts: GeneratedPrompt[]) => void;
   ```

2. In the `handleGenerate` function, after `prompts.setGeneratedPrompts(generatedPrompts)` and `prompts.pushToHistory(generatedPrompts)` (around line 128-129), add:
   ```typescript
   // Fire callback with fresh prompts (bypasses async state timing)
   overrides?.onPromptsReady?.(generatedPrompts);
   ```

3. Also add the callback invocation in the error/fallback paths (around lines 147 and 159) after setting fallback prompts:
   ```typescript
   overrides?.onPromptsReady?.(fallbackPrompts);
   ```

WHY: The callback fires synchronously with the actual prompt data, bypassing React's async state batching. The orchestrator can then immediately trigger image generation with the correct prompts.
  </action>
  <verify>
- TypeScript compiles: `npm run build` passes (or at least `npx tsc --noEmit`)
- Interface is exported and accessible
- Grep confirms pattern: `grep -n "onPromptsReady" app/features/simulator/SimulatorContext.tsx` shows interface and invocations
  </verify>
  <done>
- `GenerateOverrides` interface includes `onPromptsReady?: (prompts: GeneratedPrompt[]) => void`
- `handleGenerate` invokes callback in success path and both fallback paths
  </done>
</task>

<task type="auto">
  <name>Task 2: Update orchestrator to use callback-based propagation</name>
  <files>app/features/simulator/hooks/useAutoplayOrchestrator.ts</files>
  <action>
1. Update the `AutoplayOrchestratorDeps` interface (around line 84) to match the new callback signature:
   ```typescript
   onRegeneratePrompts: (overrides?: {
     feedback?: { positive: string; negative: string };
     onPromptsReady?: (prompts: GeneratedPrompt[]) => void;
   }) => void;
   ```

2. In the main state effect, in the 'generating' case (around lines 189-208), modify the code that calls `onRegeneratePrompts` to pass an `onPromptsReady` callback:
   ```typescript
   case 'generating': {
     if (currentIterationRef.current !== autoplay.state.currentIteration) {
       currentIterationRef.current = autoplay.state.currentIteration;
       logEvent('image_generating', `Starting image generation (iteration ${autoplay.state.currentIteration})`);

       if (autoplay.state.currentIteration > 1 || generatedPrompts.length === 0) {
         logEvent('prompt_generated', 'Regenerating prompts with feedback');
         const feedbackOverride = pendingFeedbackRef.current;
         pendingFeedbackRef.current = null;

         // Pass callback to receive prompts immediately after generation
         onRegeneratePrompts({
           feedback: feedbackOverride || undefined,
           onPromptsReady: (newPrompts) => {
             console.log('[Autoplay] Prompts ready, triggering image generation for', newPrompts.length, 'prompts');
             generateImagesFromPrompts(newPrompts.map(p => ({ id: p.id, prompt: p.prompt })));
           },
         });
       } else {
         // First iteration with existing prompts - use current prompts directly
         console.log('[Autoplay] Using existing prompts for image generation:', generatedPrompts.length, 'prompts');
         generateImagesFromPrompts(generatedPrompts.map(p => ({ id: p.id, prompt: p.prompt })));
       }
     }
     break;
   }
   ```

3. The backup effect at lines 512-534 that watches `generatedPrompts` state can remain as a safety net, but now the primary path is the callback. Add a comment explaining this:
   ```typescript
   /**
    * Effect: Backup trigger for image generation when prompts are ready during autoplay
    * Primary path is now the onPromptsReady callback in handleGenerate.
    * This effect serves as a safety net for edge cases (e.g., manual state changes).
    */
   ```

WHY: The callback-based approach fires synchronously when prompts are set, eliminating the async state timing issue. The backup effect remains for edge cases but is no longer the primary trigger path.
  </action>
  <verify>
- TypeScript compiles: `npm run build` passes
- Console log appears when starting autoplay: "[Autoplay] Prompts ready, triggering image generation for X prompts"
- Manual test: Start autoplay, observe image generation begins within 5 seconds
- Manual test: Regular "Generate" button still works (no regression)
  </verify>
  <done>
- `onRegeneratePrompts` call includes `onPromptsReady` callback
- Callback triggers `generateImagesFromPrompts` directly with fresh prompts
- Console logs confirm the callback path is executing
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Build check:** `npm run build` succeeds without TypeScript errors
2. **Single-phase autoplay test:**
   - Open app at localhost:3000
   - Add a base image
   - Click Generate to create prompts
   - Start autoplay
   - VERIFY: Image generation begins within 5 seconds (console shows "[Autoplay] Prompts ready...")
3. **Manual generate regression:**
   - Click Generate button manually
   - VERIFY: Prompts generate and display correctly (no broken behavior)
</verification>

<success_criteria>
- [ ] `GenerateOverrides` interface includes `onPromptsReady` callback
- [ ] `handleGenerate` invokes callback after setting prompts (success + fallback paths)
- [ ] Orchestrator passes callback to `onRegeneratePrompts`
- [ ] Callback triggers `generateImagesFromPrompts` with fresh prompts
- [ ] `npm run build` passes
- [ ] Starting autoplay triggers image generation within 5 seconds
- [ ] Manual Generate button works correctly (regression test)
</success_criteria>

<output>
After completion, create `.planning/phases/01-orchestration-fix/01-01-SUMMARY.md`
</output>
